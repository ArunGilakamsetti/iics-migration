name: Deploy IICS Release to Environment
run-name: Deploy IICS Release to ${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to deploy (e.g., v1.2.3)'
        required: true
      environment:
        description: 'Target environment'
        required: true
        default: 'uat'
        type: choice
        options: [uat, prod]
      project_path:
        description: 'Project path'
        required: false
        default: 'Explore/Project_Alpha.Project'

env:
  IICS_REGION: ap
  IICS_POD_HOST: dm-ap.informaticacloud.com   # Login host
  # Note: The actual pod host for API calls is passed separately

jobs:
  prepare:
    name: Prepare package for ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download IICS CLI
        run: |
          curl -L -o iics https://github.com/InformaticaCloudApplicationIntegration/Tools/raw/master/IICS%20Asset%20Management%20CLI/v2/linux-x86_64/iics
          chmod +x iics
      - name: Download release package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ inputs.version }} --pattern "*.zip" --output package.zip
      - name: Apply ${{ inputs.environment }} overrides
        run: |
          mkdir -p workspace_${{ inputs.environment }}
          ./iics extract -z package.zip -w workspace_${{ inputs.environment }}
          python3 Explore/scripts/apply_mappings.py Explore/configs/${{ inputs.environment }}_config.json workspace_${{ inputs.environment }}
          ./iics package \
            -w workspace_${{ inputs.environment }} \
            -a "${{ inputs.project_path }}" \
            -z package_${{ inputs.environment }}_final.zip
      - name: Upload prepared package
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ inputs.environment }}-${{ inputs.version }}
          path: package_${{ inputs.environment }}_final.zip

  cleanup:
    name: Cleanup ${{ inputs.environment }} (remove obsolete objects)
    runs-on: ubuntu-latest
    needs: prepare
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install requests
      - name: Download prepared package
        uses: actions/download-artifact@v4
        with:
          name: package-${{ inputs.environment }}-${{ inputs.version }}
          path: ./
      - name: Run cleanup script
        run: |
          python Explore/scripts/cleanup_target.py \
            --username "${{ secrets[format('{0}_IICS_USER', inputs.environment)] }}" \
            --password "${{ secrets[format('{0}_IICS_PWD', inputs.environment)] }}" \
            --package "package_${{ inputs.environment }}_final.zip" \
            --host "apse1.dm-ap.informaticacloud.com"   # Replace with your actual pod host
        # If you have a variable for the pod host, use it instead of hardcoding:
        # --host "${{ secrets.POD_HOST }}"

  import:
    name: Import to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: cleanup
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - name: Download IICS CLI
        run: |
          curl -L -o iics https://github.com/InformaticaCloudApplicationIntegration/Tools/raw/master/IICS%20Asset%20Management%20CLI/v2/linux-x86_64/iics
          chmod +x iics
      - name: Download prepared package
        uses: actions/download-artifact@v4
        with:
          name: package-${{ inputs.environment }}-${{ inputs.version }}
          path: ./
      - name: Import to ${{ inputs.environment }}
        run: |
          ./iics import \
            -n "${{ inputs.environment }}_Import_${{ inputs.version }}" \
            -r ${{ env.IICS_REGION }} \
            --podHostName ${{ env.IICS_POD_HOST }} \
            -u ${{ secrets[format('{0}_IICS_USER', inputs.environment)] }} \
            -p ${{ secrets[format('{0}_IICS_PWD', inputs.environment)] }} \
            -z package_${{ inputs.environment }}_final.zip \
            -s true